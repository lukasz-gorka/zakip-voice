name: Build Linux

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g., 0.9.21)'
        required: true
        type: string
      skip_deploy:
        description: 'Skip deployment to server'
        required: false
        type: boolean
        default: false

permissions:
  contents: write

jobs:
  build-linux:
    runs-on: ubuntu-22.04
    outputs:
      version: ${{ inputs.version }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable

      - name: Install dependencies (ubuntu only)
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf libssl-dev libasound2-dev libxdo-dev

      - name: Update version files
        run: |
          node scripts/set-version.js ${{ inputs.version }}

      - name: Install dependencies
        run: pnpm install

      - name: Build Tauri app
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
        with:
          tagName: v${{ inputs.version }}-linux
          releaseName: zakip voice v${{ inputs.version }} for Linux
          releaseBody: 'zakip voice Linux build v${{ inputs.version }}'
          releaseDraft: false
          prerelease: false

      - name: Apply Wayland compatibility fixes
        run: |
          chmod +x scripts/fix-appimage-linux.sh
          ./scripts/fix-appimage-linux.sh

      - name: Verify and fix signature files
        env:
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
        run: |
          BUNDLE_DIR="src-tauri/target/release/bundle"
          echo "=== All bundle files ==="
          find "$BUNDLE_DIR" -type f | sort

          # Find the .AppImage.tar.gz (updater target)
          UPDATER_FILE=""
          for f in "$BUNDLE_DIR"/appimage/*.AppImage.tar.gz; do
            [ -f "$f" ] && UPDATER_FILE="$f" && break
          done

          if [ -z "$UPDATER_FILE" ]; then
            echo "ERROR: No *.AppImage.tar.gz found in $BUNDLE_DIR/appimage/"
            ls -la "$BUNDLE_DIR/appimage/" 2>/dev/null || echo "(dir not found)"
            exit 1
          fi

          echo "Updater file: $UPDATER_FILE"
          SIG_FILE="${UPDATER_FILE}.sig"

          if [ -f "$SIG_FILE" ] && [ -s "$SIG_FILE" ]; then
            echo "Signature file exists and is non-empty: $SIG_FILE"
          else
            echo "WARNING: Signature file missing or empty, signing manually..."
            if [ -n "$TAURI_SIGNING_PRIVATE_KEY" ]; then
              pnpm tauri signer sign -k "$TAURI_SIGNING_PRIVATE_KEY" -p "${TAURI_SIGNING_PRIVATE_KEY_PASSWORD:-}" "$UPDATER_FILE"
              echo "Manually signed: $UPDATER_FILE"
            else
              echo "ERROR: TAURI_SIGNING_PRIVATE_KEY not set, cannot sign!"
              exit 1
            fi
          fi

          echo "=== Signature content (first 80 chars) ==="
          head -c 80 "$SIG_FILE" && echo "..."

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-build
          path: |
            src-tauri/target/release/bundle/**/*.AppImage
            src-tauri/target/release/bundle/**/*.AppImage.tar.gz
            src-tauri/target/release/bundle/**/*.sig
          retention-days: 5
          if-no-files-found: error

  deploy:
    needs: build-linux
    if: ${{ !inputs.skip_deploy }}
    uses: ./.github/workflows/deploy-release.yml
    with:
      version: ${{ inputs.version }}
      platform: linux
    secrets: inherit
