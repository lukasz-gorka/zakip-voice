# Apache configuration example for ai-assistant-app downloads
# Place this in /etc/apache2/sites-available/ai-assistant-downloads.conf
# Then enable: a2ensite ai-assistant-downloads

<VirtualHost *:80>
    ServerName downloads.example.com
    ServerAdmin admin@example.com

    # Redirect HTTP to HTTPS (uncomment after setting up SSL)
    # Redirect permanent / https://downloads.example.com/
</VirtualHost>

<VirtualHost *:443>
    ServerName downloads.example.com
    ServerAdmin admin@example.com

    # SSL Configuration (uncomment after setting up SSL with Let's Encrypt)
    # SSLEngine on
    # SSLCertificateFile /etc/letsencrypt/live/downloads.example.com/fullchain.pem
    # SSLCertificateKeyFile /etc/letsencrypt/live/downloads.example.com/privkey.pem
    # SSLProtocol all -SSLv3 -TLSv1 -TLSv1.1
    # SSLCipherSuite HIGH:!aNULL:!MD5

    # Root directory where files are deployed
    # This should match DEPLOY_PATH in GitHub Secrets
    DocumentRoot /var/www/ai-assistant-downloads

    <Directory /var/www/ai-assistant-downloads>
        Options -Indexes +FollowSymLinks
        AllowOverride None
        Require all granted

        # Main download page
        DirectoryIndex index.html
    </Directory>

    # API endpoints with no-cache headers
    <FilesMatch "\.(txt|json)$">
        Header set Cache-Control "no-cache, must-revalidate"
    </FilesMatch>

    # CORS for manifest.json
    <Files "manifest.json">
        Header set Access-Control-Allow-Origin "*"
    </Files>

    # Release files configuration
    <Directory /var/www/ai-assistant-downloads/releases>
        # Enable directory listing (optional)
        # Options +Indexes

        # Force download for binary files
        <FilesMatch "\.(dmg|exe|AppImage|deb|msi)$">
            Header set Content-Disposition "attachment"
            Header set Cache-Control "public, max-age=31536000, immutable"
        </FilesMatch>

        # Proper MIME types for downloads
        AddType application/x-apple-diskimage .dmg
        AddType application/x-msdownload .exe
        AddType application/x-executable .AppImage
        AddType application/x-deb .deb
        AddType application/x-msi .msi
    </Directory>

    # Logs
    ErrorLog ${APACHE_LOG_DIR}/ai-assistant-downloads-error.log
    CustomLog ${APACHE_LOG_DIR}/ai-assistant-downloads-access.log combined

    # Security headers
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-XSS-Protection "1; mode=block"

    # Compression
    <IfModule mod_deflate.c>
        AddOutputFilterByType DEFLATE text/plain
        AddOutputFilterByType DEFLATE text/html
        AddOutputFilterByType DEFLATE text/css
        AddOutputFilterByType DEFLATE application/javascript
        AddOutputFilterByType DEFLATE application/json
    </IfModule>
</VirtualHost>
