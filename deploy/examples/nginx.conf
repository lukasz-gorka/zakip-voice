# Nginx configuration example for ai-assistant-app downloads
# Place this in /etc/nginx/sites-available/ai-assistant-downloads
# Then create symlink: ln -s /etc/nginx/sites-available/ai-assistant-downloads /etc/nginx/sites-enabled/

server {
    listen 80;
    listen [::]:80;

    # Replace with your domain
    server_name downloads.example.com;

    # Redirect HTTP to HTTPS (uncomment after setting up SSL)
    # return 301 https://$server_name$request_uri;
}

server {
    # Uncomment these lines after setting up SSL with Let's Encrypt
    # listen 443 ssl http2;
    # listen [::]:443 ssl http2;
    # ssl_certificate /etc/letsencrypt/live/downloads.example.com/fullchain.pem;
    # ssl_certificate_key /etc/letsencrypt/live/downloads.example.com/privkey.pem;
    # ssl_protocols TLSv1.2 TLSv1.3;
    # ssl_ciphers HIGH:!aNULL:!MD5;

    server_name downloads.example.com;

    # Root directory where files are deployed
    # This should match DEPLOY_PATH in GitHub Secrets
    root /var/www/ai-assistant-downloads;

    # Enable directory listing for releases (optional)
    # location /releases/ {
    #     autoindex on;
    #     autoindex_exact_size off;
    #     autoindex_localtime on;
    # }

    # Main download page
    location = / {
        try_files /index.html =404;
    }

    # API endpoints
    location = /latest.txt {
        add_header Content-Type text/plain;
        add_header Cache-Control "no-cache, must-revalidate";
    }

    location = /version.json {
        add_header Content-Type application/json;
        add_header Cache-Control "no-cache, must-revalidate";
    }

    location = /manifest.json {
        add_header Content-Type application/json;
        add_header Cache-Control "no-cache, must-revalidate";
        add_header Access-Control-Allow-Origin *;
    }

    # Release files
    location /releases/ {
        # Set proper content types for downloads
        types {
            application/x-apple-diskimage dmg;
            application/x-msdownload exe;
            application/x-executable AppImage;
            application/x-deb deb;
            application/x-msi msi;
        }

        # Force download for binary files
        add_header Content-Disposition "attachment";

        # Cache release files for 1 year (they're versioned)
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    # Logs
    access_log /var/log/nginx/ai-assistant-downloads-access.log;
    error_log /var/log/nginx/ai-assistant-downloads-error.log;

    # Security headers
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;

    # Gzip compression
    gzip on;
    gzip_vary on;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml;
}
